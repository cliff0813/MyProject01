! Amazon Web Services
! Virtual Private Cloud

! AWS utilizes unique identifiers to manipulate the configuration of a VPN Connection. Each VPN Connection is assigned an identifier
! and is associated with two other identifiers, namely the Customer Gateway Identifier and Virtual Private Gateway Identifier.
!
! Your VPN Connection ID                  : vpn-0a5d81c35bb6b8e0d
! Your Virtual Private Gateway ID         : vgw-030b57e1ed1e55dd6
! Your Customer Gateway ID                : cgw-05b44230917c4e2ac

! This configuration consists of two tunnels. Both tunnels must be configured on your Customer Gateway.
! For policy based VPN connection , only a single tunnel will be up at a time to the VGW.



! -----------------------------------------IMPORTANT NOTE-----------------------------------------------------------------
! AWS by default , provides two tunnels endpoints per VPN and also dynamically generates different keys for both AWS tunnels.
! At the time of this writing , Cisco Firepower Management Center (FMC) (version 6.2.3) provides an option to specify only one
! pre-shared key per topology.
! To have redundancy , please recreate your VPN, and manually specify a common preshared key for both the tunnels on AWS console
! and then enter the same key in FTD configuration below.
! If you would like only one tunnel to AWS from the CGW , please ignore this warning and continue  with the instructions below.
! ------------------------------------------------------------------------------------------------------------------------


! -----------------------------------------------------------------------------------------------------------------------
!                                       IPSec Tunnel configuration
! -----------------------------------------------------------------------------------------------------------------------

! #1: Create Network object for VPC CIDR.

! Network objects define the local and remote subnets that will use the VPN tunnel.

! Navigate to Objects ->  Object Management -> Network -> Add Network -> Add Object

! In the “New Network object” window enter:

!   a. Name: Specify the name of the object. For ex. VPC-SUBNET
!   b. Description: Optional
!   c. Network: Subnet of your VPC CIDR . If for ex. the VPC CIDR is 192.168.0.0/16 specify 192.168.0.0/16 here.

! #2: Create a second Network object for the Local Subnet behind Cisco Firepower Threat Defense (FTD) device ,by repeating the steps mentioned in #1.

! In the “New Network object” window enter:

!   a. Name: Specify the name of the object For eg. LOCAL-SUBNET
!   b. Description: Optional
!   c. Network: Local Subnet behind the FTD device . If for ex. the LOCAL subnet behind FTD is 10.10.0.0/16 specify 10.10.0.0/16 here.

! #3: Create IKEv1 policy

! A policy is established for the supported ISAKMP encryption, authentication, Diffie-Hellman, lifetime,
! and authentication method. The IKE peer is configured with the supported IKE encryption, authentication, Diffie-Hellman, lifetime and key.
! parameters. Please note, these sample configurations are for the minimum requirement of AES128, SHA1, and DH Group 2.
! Category "VPN" connections in the GovCloud region have a minimum requirement of AES128, SHA2, and DH Group 14.
! You will need to modify these sample configuration files to take advantage of AES256, SHA256, or other DH
! groups like 2, 14-18, 22, 23, and 24.
! NOTE: If you customized tunnel options when creating or modifying your VPN connection, you may need to modify these sample configurations to match the custom settings for your tunnels.
!
! Higher parameters are only available for VPNs of category "VPN," and not for "VPN-Classic".
! The address of the external interface for your customer gateway must be a static address.

! Navigate to  Objects -> Object Management -> VPN -> IKEv1 Policy -> Add IKEv1 Policy
! Specify the following details:

!   a. Name: AWS-IKE-vpn-0a5d81c35bb6b8e0d
!   b. Description: optional
!   c. Priority: 1
!   d. Encryption: AES-128
!   e. Hash: SHA
!   f. Diffie-Hellman Group: 2
!   g. Lifetime: 28800 seconds
!   h. Authentication method: Preshared Key

! Click save.

! #4: Create IPsec policy

! An IPsec proposal defines the IPsec parameters for encryption, authentication, Diffie-Hellman, and lifetime.
! Please note, these sample configurations are for the minimum requirement of AES128, SHA1, and DH Group 2.
! Category "VPN" connections in the GovCloud region have a minimum requirement of AES128, SHA2, and DH Group 14.
! You will need to modify these sample configuration files to take advantage of AES256, SHA256, or other DH
! groups like 2, 14-18, 22, 23, and 24.
! Higher parameters are only available for VPNs of category "VPN," and not for "VPN-Classic".

! Navigate to  Objects -> Object Management -> VPN -> IKEv1 IPSec Proposal -> Add IKEv1 IPSEC Proposal

! Specify the following details:

!   a. Name: AWS-IPSEC-vpn-0a5d81c35bb6b8e0d
!   b. Description: optional
!   c. ESP Encryption: aes-128
!   d. ESP Hash: sha

! Click save.

! #5: Build IPSEC VPN

! Click on Devices -> VPN -> Site-to-Site VPN
! Select Add VPN -> Firepower Thread Defense Device

! Specify the following details:

!   a. Topology Name:AWS-vpn-0a5d81c35bb6b8e0d
!   b. Network Topology: Point to Point
!   c. IKE Version: IKEv1

! In the Endpoints Tab ,specify the following details:

! Click on the green + button next to Node A:

!   a. Device: Choose Extranet
!   b. IP Address: 52.197.13.242,54.168.65.54
!   c. Certificate Map: Leave blank
!   d. Protected Networks:  Click on the "Green" add button. Under "Available Networks" choose the network object created for VPC CIDR
!   created in step 1 and move it under "Selected Networks".

!   Select OK

! Click on the green + button next to Node B.

!   a. Device: Select the FMC managed FTD device on which the tunnel will be terminated
!   b. Interface: Select the interface name on which the tunnel is terminated
!   c. IP Address: 59.120.7.130
!   If the FTD is behind NAT this will be the ip address of the outside interface of the FTD.
!   d. Connection Type: Bidirectional
!   e. Protected Networks:  Click on the "Green" add button . Under "Available Networks" choose the network object created for LOCAL LAN
!   created in  Step 2  and move it under "Selected Networks"
!   Select OK

! In the IKE Tab , specify the following details:

!   IKEv1 Settings
!   a. Policy: Select the IKEv1 policy created in #3
!   b. Authentication Type: Pre-shared Manual Key
!   c. Key: C2.ittIjV2uy.lYaBxNndMnHwHTbAIKe
!   d. Confirm Key: C2.ittIjV2uy.lYaBxNndMnHwHTbAIKe
!   The pre-shared key tunnel specified above is for VGW IP - 52.197.13.242
!   Specify the pre-shared key as Aegiji5jK8K4BVUmIQVAbMwI.sKSfvmB for creating the tunnel to the VGW IP - 54.168.65.54
!   For more details please read the NOTE at the top.

!   In the IPSEC tab , specify the following details:

!   a. Crypto Map Type: Static
!   b. Transform Sets: Select the IPSEC policy created in #4
!   c. Enable Perfect Forward Secrecy: Select the checkbox and set the Modulus group to 2
!   d. Lifetime duration: 3600 seconds


! #6: Configure Access Policies to Permit Traffic

! You need to add rules under access policies to permit Traffic from FTD LAN to AWS.
! Policies -> Access control -> Select the access policy for your FTD device -> Click the edit button next to the policy.
! In the Rules tab -> Select Add Rule -> Create a rule that permits traffic from LOCAL-LAN to VPC-CIDR.
! Create a second rule that allows traffic from VPC-CIDR to LOCAL-LAN, if VPC-CIDR needs to initiate traffic once the tunnel is up.
! Note that there may be multiple access rules configured on your Customer Gateway. These rules may be conflicting with the new rules that you are adding.
! It is recommended to position the access rules such that they are evaluated in an order before any other conflicting rules.

! #7: NAT Exemption

! If you are performing NAT on your Customer Gateway, you may have to add a nat exemption rule to permit traffic from your local subnet to the VPC subnet
! and vice versa.
! This varies depending on how NAT is set up.  It should be configured along the lines of:

! Go to devices -> NAT . Select the NAT Policy for the FTD device  and click on Add rule:

! Create a NAT rule with these details:

!   a.Type:  Manual NAT Rule
!   b.Source Interface Object: Specify the Source Zone here.
!   c.Destination Interface Object: Specify the destination Zone here.
!   d.Original Sources: Specify the LOCAL network object created in #2 here. For ex LOCAL-SUBNET
!   e.Original Destinations: Specify the VPC network object created in #2 here. For ex VPC-SUBNET
!   f.Translated Sources: Specify the LOCAL network object created in #2 here. For ex LOCAL-SUBNET
!   g.Translated Destinations: Specify the VPC network object created in #2 here. For ex VPC-SUBNET

! Select OK.

! Note that there may be multiple firewall rules configured on your Customer Gateway. These rules may be conflicting with the nat exemption rule.
! It is recommended to position the nat exemption rules such that they are evaluated in an order before any other conflicting rules.

! #8 Deploy

! All configuration done above should be deployed to the Firepower Threat Defense(FTD) device from the FMC . Click "Deploy" on the right hand corner.
! Select the FTD device which is the CGW and click on Deploy.


!
!-----------------------------------------------------------------------------------------------------------------------
!  Additional Notes and Questions
!  - Amazon Virtual Private Cloud Getting Started Guide:
!       http://docs.amazonwebservices.com/AmazonVPC/latest/GettingStartedGuide
!  - Amazon Virtual Private Cloud Network Administrator Guide:
!       http://docs.amazonwebservices.com/AmazonVPC/latest/NetworkAdminGuide